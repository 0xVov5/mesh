# Based on https://github.com/actions-rs/example/blob/master/.github/workflows/quickstart.yml

# on: [pull_request]

on:
  push:
    tags:
      - '*'

name: Release artifacts

jobs:
  release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.65.0
          target: wasm32-unknown-unknown
          override: true

      # no way of looping... let's just do one dir
      # - name: Build schemas
      #   uses: actions-rs/cargo@v1
      #   with:
      #     toolchain: 1.65.0
      #     command: schema
      #     args: --workspace

      - name: Build Wasm images
        uses: addnab/docker-run-action@v3
        with:
          image: cosmwasm/workspace-optimizer:0.12.13
          options: -v ${{ github.workspace }}:/code --mount type=volume,source=contract_cache,target=/code/target --mount type=volume,source=registry_cache,target=/usr/local/cargo/registry
          run: optimize_workspace.sh

      - name: Build schemas
        # Need run, as uses doesn't work with 'working-directory'
        run: cargo +1.65.0 schema
        working-directory: contracts/vault

      - name: Build schemas
        # Need run, as uses doesn't work with 'working-directory'
        run: cargo +1.65.0 schema
        working-directory: contracts/vault

      - name: Build schemas
        # Need run, as uses doesn't work with 'working-directory'
        run: cargo +1.65.0 schema
        working-directory: contracts/native-staking

      - name: Build schemas
        # Need run, as uses doesn't work with 'working-directory'
        run: cargo +1.65.0 schema
        working-directory: contracts/native-staking-proxy

      - name: Build schemas
        # Need run, as uses doesn't work with 'working-directory'
        run: cargo +1.65.0 schema
        working-directory: contracts/external-staking

      # See https://trstringer.com/github-actions-create-release-upload-artifacts/
      - name: Create release
        uses: softprops/action-gh-release@v1
        id: create_release
        with:
          draft: false
          prerelease: false
          body_path: RELEASE_NOTES.md
          tag_name: ${{ github.ref }}
          files: |
            artifacts/*
            contracts/vault/schema/mesh-vault.json
            contracts/native-staking/schema/mesh-native-staking.json
            contracts/native-staking-proxy/schema/mesh-native-staking-proxy.json
            contracts/external-staking/schema/external-staking.json

      # - name: Compile WASM contract
      #   uses: actions-rs/cargo@v1
      #   with:
      #     toolchain: 1.65.0
      #     command: wasm
      #   env:
      #     RUSTFLAGS: "-C link-arg=-s"
